<!doctype html>
<html lang="en">
  <head>
    <title>RED ☎️</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- <link rel="stylesheet" href="style.css" charset="utf-8" /> -->
  </head>
  <body>
    <style>
      #outgoing {
        width: 600px;
        word-wrap: break-word;
        white-space: normal;
      }
    </style>
    <label for="mypubkey">my pubkey</label>
    <input type="text" name="mypubkey" id="mypubkey"/>
    <label for="pubkeytocall">node pubkey to call</label>
    <input type="text" name="pubkeytocall" id="pubkeytocall"/>
    <button id="callnode">call node</button>
    <form>
      <textarea id="incoming"></textarea>
      <button type="submit">submit</button>
    </form>
    <pre id="outgoing"></pre>
    <script src="simplepeer.min.js"></script>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="application/javascript" src="client.js"></script>
    <script>
      let signaldata
      let isConnected = false
      let p

      function initializesp (isInitiator, datatosignal) {
        p = new SimplePeer({
          // initiator: location.hash === '#1',
          initiator: isInitiator,
          trickle: false
        })

        p.on('error', err => console.log('error', err))

        p.on('signal', data => {
          console.log('SIGNAL', JSON.stringify(data))
          document.querySelector('#outgoing').textContent = JSON.stringify(data)
          signaldata = data
        })

        // document.querySelector('form').addEventListener('submit', ev => {
        //   ev.preventDefault()
        //   p.signal(JSON.parse(document.querySelector('#incoming').value))
        // })

        p.on('connect', () => {
          isConnected = true
          console.log('CONNECT, sending stuff')
          p.send('whatever' + Math.random())
        })

        p.on('data', data => {
          console.log('received data: ' + data)
        })        

        if(datatosignal) {
          p.signal(datatosignal)
        }
      }


      function callpubkey(){
                // pass this data to the peer over impervious
        let senddata = {
            "msg": JSON.stringify(signaldata),
            "pubkey": document.getElementById('pubkeytocall').value
        }
        console.log("calling impervious with ", senddata)
        fetch('./callnode', {
          method: 'post',
          headers: {
            'Accept': 'application/json, text/plain, */*',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(senddata)
        }).then(res => res.json())
          .then(res => {
            console.log(res)

            // start polling /activecall to check for answer
            let interval = setInterval(function(){
              fetch('./activecall', {
                method: 'get',
                headers: {
                  'Accept': 'application/json, text/plain, */*',
                  'Content-Type': 'application/json'
                },
                // body: JSON.stringify(senddata)
              }).then(res => res.json())
                .then(res => {
                  console.log("activecall ", res)
                  if(res.data) {
                    p.signal(res.data)
                    clearInterval(interval)                    
                  }


                })
            }, 3000);

          })
      }


      $(function(){

        $("#callnode").on('click touch', function () {
          callpubkey()
        })
      
        let dataCookie = getCookie('data')
        // console.log("dataCookie ", dataCookie)
        deleteCookie('data')

        if (dataCookie) {
          // receiving a call
          const data = parseObjectFromCookie(dataCookie)
          console.log("got cookie data: ", data)
          initializesp (false, data.data)
          // p.signal(data.data)
          $("#pubkeytocall").val(data.fromPubkey)
          $("#callnode").text("accept call")
          // work with data. `data` is equal to `visitCard` from the server
        } else {
          // handle data not found
          console.log("no cookie data found")
          // no pending call to answer, initialize for outbound call
          initializesp (true)
        }

      })

      const getCookie = (name) => {
        const value = "; " + document.cookie;
        const parts = value.split("; " + name + "=");
        if (parts.length === 2) return parts.pop().split(";").shift();
      };

      const deleteCookie = (name) => {
        document.cookie = name + '=; max-age=0;';
      };

      const parseObjectFromCookie = (cookie) => {
        const decodedCookie = decodeURIComponent(cookie);
        return JSON.parse(decodedCookie);
      };

    </script>
  </body>
</html>